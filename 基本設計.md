# Obsidian Image Paste Plugin - 基本設計

## 概要

Obsidian のプラグイン。  
クリップボードの画像を `Cmd+Option+V` (Mac) / `Ctrl+Alt+V` (Win) で即座に保存・挿入する。

## 設計思想

- **シンプル**: 必要最小限の機能に絞る
- **クリーン**: 読みやすく保守しやすいコード
- **実用的**: 日常的なメモ作成を快適にする

## 機能要件

### 1. 画像の貼り付け

**トリガー**: `Cmd+Option+V` (Mac) / `Ctrl+Alt+V` (Win)

**処理フロー**:

1. クリップボードから画像を取得
2. 設定に従ってファイル名を生成
3. 指定フォルダに保存
4. エディタに挿入

### 2. 設定項目

| 設定名            | デフォルト値                                                                                       | 説明                   |
| ----------------- | -------------------------------------------------------------------------------------------------- | ---------------------- |
| `imageFolderPath` | `${currentFileDir}/images`                                                                         | 画像保存先フォルダ     |
| `namePrefix`      | `${currentFileNameWithoutExt}_`                                                                    | ファイル名の接頭辞     |
| `defaultName`     | `image-YYMMDD-HHmmss`                                                                              | ファイル名本体         |
| `insertPattern`   | `<img src='./images/${imageFileName}' alt='image' style='width: 600px; border: 1px solid black;'>` | 挿入する HTML/Markdown |

### 3. 変数システム

設定で使える変数:

- `${currentFileDir}`: 現在のファイルのディレクトリ
- `${currentFileNameWithoutExt}`: 現在のファイル名（拡張子なし）
- `${imageFileName}`: 保存された画像のファイル名
- `YYMMDD-HHmmss`: 日時フォーマット（例: `20241105_143020`）

**ファイル名の生成**:
`namePrefix` + `defaultName` + `.拡張子`

**例**:

- 設定: `namePrefix: "${currentFileNameWithoutExt}_"`, `defaultName: "image-YYMMDD-HHmmss"`
- 結果: `meeting-notes-image-20241105-143020.png`

## 技術仕様

### ファイル構成

```
src/
  ├── main.ts           # プラグインエントリーポイント
  ├── settings.ts       # 設定の定義と画面
  ├── paste-handler.ts  # 貼り付け処理の実装
  └── utils.ts          # ユーティリティ関数
```

### 依存ライブラリ

- `obsidian`: Obsidian API
- 追加の外部ライブラリは使わない（シンプルに保つため）

### コア処理

#### 1. クリップボード取得

```typescript
// Electron clipboard を使用（Obsidianの標準環境）
const { clipboard } = require("electron");
const image = clipboard.readImage();
```

#### 2. ファイル名生成

```typescript
function generateFilename(
  prefix: string,
  namePattern: string,
  context: Context
): string {
  const timestamp = formatTimestamp(new Date()); // YYMMDD-HHmmss

  // 変数を展開
  const expandedPrefix = prefix.replace(
    "${currentFileNameWithoutExt}",
    context.noteName
  );

  const expandedName = namePattern.replace(/YYMMDD-HHmmss/g, timestamp);

  // 連結してサニタイズ
  const filename = (expandedPrefix + expandedName).replace(
    /[\\/:*?"<>|]/g,
    "_"
  );

  return filename;
}
```

#### 3. ファイル保存

```typescript
async function saveImage(
  vault: Vault,
  folderPath: string,
  filename: string,
  imageData: Buffer
): Promise<string> {
  // フォルダがなければ作成
  if (!(await vault.adapter.exists(folderPath))) {
    await vault.adapter.mkdir(folderPath);
  }

  // 重複チェック（連番付与）
  const finalPath = await getUniqueFilename(folderPath, filename);

  // 保存
  await vault.adapter.writeBinary(finalPath, imageData);

  return finalPath;
}
```

#### 4. エディタ挿入

```typescript
function insertToEditor(
  editor: Editor,
  insertPattern: string,
  filename: string
) {
  const text = insertPattern.replace("${imageFileName}", filename);
  editor.replaceSelection(text);
}
```

## 開発環境

1. `npm install` で依存関係をインストール
2. `npm run dev` でビルド監視
3. Obsidian の.obsidian/plugins フォルダにシンボリックリンク
4. Obsidian で動作確認

## UI/UX

### 設定画面

4 つの設定項目:

```
画像保存フォルダ: [${currentFileDir}/images]
  変数: ${currentFileDir}

ファイル名接頭辞: [${currentFileNameWithoutExt}_]
  変数: ${currentFileNameWithoutExt}

ファイル名本体: [image-YYMMDD-HHmmss]
  YYMMDD-HHmmssが日時に置換されます

挿入パターン: [<img src='./images/${imageFileName}' alt='image' style='width: 600px; border: 1px solid black;'>]
  変数: ${imageFileName}
```

### 動作

- 成功時: サイレント（通知なし）でスムーズ
- 失敗時: サイレント（通知なし）でスムーズ

## まとめ

このプラグインは「画像をサッと貼り付ける」という 1 つのことをシンプルに実現することに集中します。  
複雑な機能や厳密な検証は必要に応じて後から追加できますが、まずは動くものを作ることを優先します。
